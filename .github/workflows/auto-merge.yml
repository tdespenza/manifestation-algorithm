name: Auto-Merge Dev to Main

# Runs after the CI workflow completes on the dev branch.
# If every CI job passed, this workflow merges dev into main and tags the release.
on:
  workflow_run:
    workflows: ['Continuous Integration']
    branches: [dev]
    types: [completed]

permissions:
  contents: write

jobs:
  merge:
    name: Merge Dev into Main
    # Only proceed when every CI job succeeded.
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT }}

      - name: Configure Git Identity
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          # Always push via PAT so the tag push fires workflow triggers.
          # GITHUB_TOKEN pushes are intentionally blocked from firing downstream events.
          git remote set-url origin "https://x-access-token:${{ secrets.PAT }}@github.com/${{ github.repository }}"

      - name: Capture Dev Commit Message
        id: devmsg
        run: git log --format=%B -1 origin/dev > /tmp/dev-commit-msg.txt

      - name: Merge Dev into Main
        run: |
          git checkout main
          git merge --no-ff origin/dev \
            -m "chore: auto-merge dev into main (CI passed on ${{ github.event.workflow_run.head_sha }})"
          git push origin main

      - name: Set Up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20

      - name: Bump Version
        id: bump
        run: |
          node scripts/bump-version.js /tmp/dev-commit-msg.txt
          echo "version=$(jq -r .version package.json)" >> "$GITHUB_OUTPUT"

      - name: Generate Changelog
        uses: orhun/git-cliff-action@v4
        with:
          config: cliff.toml
          args: --verbose --tag "v${{ steps.bump.outputs.version }}"
        env:
          OUTPUT: CHANGELOG.md
          GITHUB_REPO: ${{ github.repository }}

      - name: Commit and Push Version Bump
        run: |
          VERSION="${{ steps.bump.outputs.version }}"
          git add package.json src-tauri/Cargo.toml src-tauri/tauri.conf.json src-tauri/Cargo.lock CHANGELOG.md
          git commit -m "chore(release): bump version to v${VERSION} [skip ci]"
          git push origin main

      - name: Read Version from package.json
        id: version
        run: echo "tag=v$(jq -r .version package.json)" >> "$GITHUB_OUTPUT"

      - name: Tag and Push Release
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          if git ls-remote --tags origin "$TAG" | grep -q .; then
            echo "ERROR: Tag $TAG already exists on remote." >&2
            exit 1
          fi
          git tag "$TAG"
          git push origin "$TAG"
          echo "Pushed tag $TAG â€” release.yml will now build and publish."

      - name: Sync Version Bump to Dev
        run: |
          git checkout dev
          git pull origin dev
          git merge --no-ff origin/main \
            -m "chore: sync version bump from main back to dev [skip ci]"
          git push origin dev
          echo "Dev branch synced with main version bump."
