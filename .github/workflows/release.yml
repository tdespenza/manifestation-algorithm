name: Publish Release

# Triggered directly when the Auto-Merge Dev to Main workflow completes
# successfully. Using workflow_run is the only reliable way to chain off a
# bot-authenticated merge — tag-push triggers are frequently suppressed by
# GitHub when the push originates from a workflow token.
on:
  workflow_run:
    workflows: ['Auto-Merge Dev to Main']
    types: [completed]

permissions:
  contents: write

jobs:
  # ─────────────────────────────────────────────────────────────────────────
  # DESIGN: tauri-action is used ONLY to build — no release-management inputs
  # (releaseId / tagName / releaseName) are passed, so it never touches GitHub
  # Releases.  Built installers are stashed in GitHub Actions artifact storage
  # and collected by the release job below, which creates the release
  # atomically with all files already present.  This eliminates the entire
  # class of "immutable release" / draft-publish race errors.
  # ─────────────────────────────────────────────────────────────────────────

  # ── 1. Resolve the version tag ────────────────────────────────────────────
  resolve-tag:
    name: Resolve Version Tag
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.version.outputs.tag }}
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Read version from package.json
        id: version
        run: echo "tag=v$(jq -r .version package.json)" >> "$GITHUB_OUTPUT"

  # ── 2. Build all three platforms in parallel ──────────────────────────────
  build:
    name: Build (${{ matrix.name }})
    needs: resolve-tag
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            name: Linux
            artifact-paths: |
              src-tauri/target/release/bundle/deb/*.deb
              src-tauri/target/release/bundle/appimage/*.AppImage
          - os: windows-latest
            name: Windows
            artifact-paths: |
              src-tauri/target/release/bundle/msi/*.msi
              src-tauri/target/release/bundle/nsis/*.exe
          - os: macos-latest
            name: macOS
            artifact-paths: |
              src-tauri/target/release/bundle/macos/*.dmg
              src-tauri/target/release/bundle/macos/*.app.tar.gz

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Set Up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Set Up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust Dependencies
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install Linux System Dependencies
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            libgtk-3-dev \
            libssl-dev \
            libsoup-3.0-dev \
            pkg-config

      - name: Install Dependencies
        run: npm ci

      - name: Build
        uses: tauri-apps/tauri-action@v0
        # No releaseId / tagName / releaseName — build only, no release management.

      - name: Upload installers to Actions artifact storage
        uses: actions/upload-artifact@v4
        with:
          name: installers-${{ matrix.name }}
          path: ${{ matrix.artifact-paths }}
          if-no-files-found: error
          retention-days: 1

  # ── 3. Create release and upload all installers in one atomic step ────────
  # Runs only after every platform build succeeds.  All artifacts are already
  # in Actions storage, so we delete any stale release, then create a fresh
  # published release with all files in a single gh release create call.
  # No draft-to-published transition, no race condition, no immutable errors.
  release:
    name: Publish Release
    needs: [resolve-tag, build]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Download all installer artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: installers-*
          path: dist
          merge-multiple: true

      - name: List downloaded files
        run: find dist -type f | sort

      - name: Delete any existing release for this tag
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release delete "${{ needs.resolve-tag.outputs.tag }}" \
            --repo "${{ github.repository }}" \
            --yes 2>/dev/null || true

      - name: Create and publish release with all installers
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.resolve-tag.outputs.tag }}"
          PRERELEASE_FLAG=""
          if echo "$TAG" | grep -q '-'; then
            PRERELEASE_FLAG="--prerelease"
          fi

          gh release create "$TAG" dist/* \
            --repo "${{ github.repository }}" \
            --title "Manifestation Algorithm $TAG" \
            --notes "## What's new
          See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/${TAG}/CHANGELOG.md) for full release notes.

          ## Installation
          Download the installer for your platform below." \
            $PRERELEASE_FLAG

